<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聚合直播</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid px-3">
            <a class="navbar-brand fs-4" href="/">
                <i class="bi bi-broadcast"></i> 聚合直播
            </a>
            
            <!-- Spacer to push elements to the right -->
            <div class="flex-grow-1"></div>
            
            <!-- Right-aligned elements in correct order -->
            <div class="d-flex gap-2 align-items-center ms-auto">
                <!-- Refresh indicator (rightmost) -->
                <div id="refreshIndicator" class="d-none" role="status">
                    <i class="bi bi-arrow-repeat refresh-animation"></i>
                    <span class="visually-hidden">加载中...</span>
                </div>
                
                                
                <!-- Group selection dropdown (right second) -->
                <div class="dropdown">
                    <button class="btn btn-light" type="button" id="groupDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-collection"></i> <span id="currentGroupName">全部关注</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="groupDropdown" id="groupMenu">
                        <!-- Groups will be populated dynamically -->
                    </ul>
                </div>
                
                                <!-- Dark/Light mode toggle button -->
                <button id="themeToggle" class="btn btn-light" type="button" title="切换深色/浅色模式">
                    <i class="bi bi-moon"></i>
                </button>
                
                <!-- User menu -->
                <div class="dropdown">
                    <button class="btn btn-light" type="button" id="userMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuDropdown">
                        <!-- User name (click to show modal) -->
                        <li>
                            <button class="dropdown-item d-flex align-items-center" onclick="SettingsManager.showUserInfoModal()" title="用户信息">
                                <i class="bi bi-person-circle me-2"></i>
                                <span id="currentUsername">admin</span>
                            </button>
                        </li>
                        
                        <!-- Auto update control button -->
                        <li>
                            <button id="autoUpdateToggle" class="dropdown-item d-flex align-items-center" type="button" onclick="Utils.toggleAutoUpdate()" title="切换自动更新">
                                <i class="bi bi-play-circle me-2"></i>
                                <span>启动自动更新</span>
                            </button>
                        </li>
                        <li>
                            <button id="manualUpdateBtn" class="dropdown-item d-flex align-items-center" type="button" onclick="Utils.manualUpdate()" title="立即更新所有直播间">
                                <i class="bi bi-arrow-clockwise me-2"></i>
                                <span>立即手动更新</span>
                            </button>
                        </li>
                        
                        <!-- Add room -->
                        <li>
                            <button class="dropdown-item d-flex align-items-center" onclick="modalManager.showAddModal()" title="添加直播间">
                                <i class="bi bi-plus-lg me-2"></i>
                                <span>添加新直播间</span>
                            </button>
                        </li>
                        
                        <!-- Settings button -->
                        <li>
                            <button class="dropdown-item d-flex align-items-center" onclick="SettingsManager.showSettingsModal()" title="设置">
                                <i class="bi bi-gear me-2"></i>
                                <span>设置</span>
                            </button>
                        </li>
                        
                        <!-- Admin menu item -->
                        <li id="adminMenuItem" style="display: none;">
                            <a class="dropdown-item d-flex align-items-center" href="#" onclick="AdminManager.showAdminModal()">
                                <i class="bi bi-shield-lock me-2"></i>
                                <span>管理员控制台</span>
                            </a>
                        </li>
                        
                        <!-- Logout -->
                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="#" id="logoutButton">
                                <i class="bi bi-box-arrow-right me-2"></i>
                                <span>退出登录</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="room-container" id="roomContainer">
            <!-- Initial empty state -->
            <div class="empty-state" id="emptyState">
                <i class="bi bi-cloud-plus" style="font-size: 48px; color: #bdc3c7;"></i>
                <h4 class="mt-3">暂无直播间</h4>
                <p>点击右上角的"添加直播间"按钮开始添加你想要的直播间</p>
            </div>
        </div>
    </div>

    <!-- API settings modal -->
    <div class="modal fade" id="apiSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">抖音API设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">抖音API地址</label>
                        <input type="text" class="form-control" id="douyinApiUrl"
                               placeholder="请输入抖音API基础地址">
                        <div class="form-text">默认使用 https://douyin.wtf</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="SettingsManager.saveApiSettings()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh settings modal -->
    <div class="modal fade" id="refreshSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">刷新频率设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Refresh frequency (minutes)</label>
                        <input type="number" class="form-control" id="refreshInterval"
                               placeholder="Please enter refresh frequency (minutes)" min="1" step="1">
                        <div class="form-text">Please enter positive integers, e.g., 5, 10, 15, 30</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="SettingsManager.saveRefreshSettings()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add room modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加直播间</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">直播间URL</label>
                        <input type="text" class="form-control" id="modalRoomUrl"
                               placeholder="支持：斗鱼、虎牙、哔哩哔哩、抖音直播间链接">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="roomManager.addRoom(document.getElementById('modalRoomUrl').value.trim())">添加</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create group modal -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建新分组</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">分组名称</label>
                        <input type="text" class="form-control" id="newGroupName"
                               placeholder="请输入分组名称">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="GroupManager.createNewGroup()">创建</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Group assignment modal -->
    <div class="modal fade" id="groupAssignmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">设置分组</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="groupAssignmentRoomUrl">
                    <div class="mb-3">
                        <label class="form-label">Select groups (multiple selection allowed)</label>
                        <div id="groupCheckboxes">
                            <!-- Group checkboxes will be generated dynamically here -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="GroupManager.showCreateGroupModalFromAssignment()">
                            <i class="bi bi-plus-circle"></i> 创建新分组
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="GroupManager.saveGroupAssignment()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Room options dialog -->
    <div class="modal fade" id="roomOptionsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header text-center py-3 border-bottom-0">
                    <div class="w-100">
                        <img id="roomOptionsAvatar" src="" alt="主播头像" class="rounded-circle mb-2" style="width: 48px; height: 48px; object-fit: cover;">
                        <h5 class="modal-title w-100" id="roomOptionsTitle">直播间选项</h5>
                    </div>
                </div>
                <div class="modal-body text-center">
                    <input type="hidden" id="roomOptionsUrl">
                    <input type="hidden" id="roomOptionsAnchorName">
                    
                    <!-- Live cover -->
                    <div class="mb-3">
                        <img id="roomOptionsCover" src="" alt="直播封面" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="RoomOperations.openGroupAssignmentFromOptions()">
                            <i class="bi bi-folder-plus"></i> 设置分组
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="RoomOperations.deleteRoomFromOptions()">
                            <i class="bi bi-x-lg"></i> 取消关注
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User info modal -->
    <div class="modal fade" id="userInfoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">用户信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">用户名</label>
                        <input type="text" class="form-control" id="userInfoUsername" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">用户头像</label>
                        <div class="d-flex align-items-center">
                            <img id="userInfoAvatar" src="" alt="用户头像" class="rounded-circle me-3" style="width: 64px; height: 64px; object-fit: cover;">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="SettingsManager.changeUserAvatar()">更换头像</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">新密码</label>
                        <input type="password" class="form-control" id="userInfoNewPassword" placeholder="留空表示不修改">
                        <div class="form-text">密码长度至少为6位</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">确认新密码</label>
                        <input type="password" class="form-control" id="userInfoConfirmPassword" placeholder="再次输入新密码">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="SettingsManager.saveUserInfo()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Douyin API settings -->
                    <div class="mb-4">
                        <h6 class="mb-3">抖音API设置</h6>
                        <div class="mb-3">
                            <label class="form-label">抖音API地址</label>
                            <input type="text" class="form-control" id="settingsDouyinApiUrl"
                                   placeholder="请输入抖音API基础地址">
                            <div class="form-text">默认使用 https://douyin.wtf</div>
                        </div>
                    </div>
                    
                    <!-- Refresh frequency settings -->
                    <div class="mb-3">
                        <h6 class="mb-3">刷新频率设置</h6>
                        <div class="mb-3">
                            <label class="form-label">Refresh frequency (minutes)</label>
                            <input type="number" class="form-control" id="settingsRefreshInterval"
                                   placeholder="Please enter refresh frequency (minutes)" min="1" step="1">
                            <div class="form-text">Please enter positive integers, e.g., 5, 10, 15, 30</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="SettingsManager.saveSettings()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin console modal -->
    <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear-fill me-2"></i> 管理员控制台
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Registration control -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">注册控制</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="allowRegistrationSwitch">
                                <label class="form-check-label" for="allowRegistrationSwitch">
                                    允许新用户注册
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- User management -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">用户管理</h6>
                            <button type="button" class="btn btn-sm btn-primary" onclick="AdminManager.showCreateUserModal()">
                                <i class="bi bi-person-plus"></i> 添加用户
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>用户名</th>
                                            <th>角色</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <!-- User list will be generated dynamically here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="AdminManager.saveAdminConfig()">保存设置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit user permissions modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑用户权限</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">用户名</label>
                        <input type="text" class="form-control" id="editUsername" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">新密码（留空表示不修改）</label>
                        <input type="password" class="form-control" id="editPassword" placeholder="留空表示不修改">
                        <div class="form-text">密码长度至少为6位</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editIsAdmin">
                            <label class="form-check-label" for="editIsAdmin">
                                管理员权限
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">
                            注意：修改权限后需要用户重新登录生效
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="AdminManager.saveUserPermissions()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create user modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建新用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">用户名</label>
                        <input type="text" class="form-control" id="newUsername" placeholder="请输入用户名">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">密码</label>
                        <input type="password" class="form-control" id="newPassword" placeholder="请输入密码">
                        <div class="form-text">密码长度至少为6位</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">确认密码</label>
                        <input type="password" class="form-control" id="newConfirmPassword" placeholder="请再次输入密码">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="newUserIsAdmin">
                            <label class="form-check-label" for="newUserIsAdmin">
                                管理员权限
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="AdminManager.createNewUser()">创建用户</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Basic configuration -->
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
    
    <!-- Tool modules -->
    <script src="{{ url_for('static', filename='js/cache.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/platform.js') }}"></script>
    
    <!-- Core modules -->
    <script src="{{ url_for('static', filename='js/modules/stateManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/roomRenderer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/roomManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/modalManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/timerService.js') }}"></script>
    
    <!-- Bootstrap framework -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Application modules -->
    <script src="{{ url_for('static', filename='js/modules/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/admin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/groupManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/settings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/roomOperations.js') }}"></script>
    
    <!-- Application initialization -->
    <script>
        // 创建核心实例
        const roomRenderer = new RoomRenderer('roomContainer', 'emptyState');
        const roomManager = new RoomManager(stateManager, roomRenderer);
        const modalManager = new ModalManager();
        
        // 添加登出按钮事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    if (typeof AuthManager !== 'undefined') {
                        AuthManager.logout();
                    } else {
                        console.error('AuthManager is not defined');
                        // Fallback: clear local storage and redirect to login
                        localStorage.removeItem(CONFIG.CACHE_KEY);
                        localStorage.removeItem(CONFIG.CACHE_TIMESTAMP);
                        window.location.href = '/login';
                    }
                });
            }
        });
        
        // 状态变化监听
        stateManager.addListener((rooms) => {
            // 更新房间显示
            const currentGroupRooms = stateManager.getCurrentGroupRooms();
            roomRenderer.renderRooms(currentGroupRooms);
            
            // 更新分组菜单
            GroupManager.updateGroupMenu();
        });
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 初始化用户认证（必须在最前面）
            AuthManager.initUserAuth();
            
            // 初始化主题切换
            Utils.initThemeToggle();
            
            // 初始化模态框管理器
            modalManager.init();
            modalManager.bindEnterKey(roomManager);
            
            // 添加登出按钮事件监听器
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    if (typeof AuthManager !== 'undefined') {
                        AuthManager.logout();
                    } else {
                        console.error('AuthManager is not defined');
                        // Fallback: clear local storage and redirect to login
                        localStorage.removeItem(CONFIG.CACHE_KEY);
                        localStorage.removeItem(CONFIG.CACHE_TIMESTAMP);
                        window.location.href = '/login';
                    }
                });
            }
            
            // 加载分组数据
            GroupManager.loadGroups();
            
            // 加载抖音API配置
            Utils.loadDouyinConfig();
            
            // 优先使用缓存数据
            const cached = CacheManager.loadFromCache();
            if (cached && cached.length > 0) {
                stateManager.setRooms(cached);
                const currentGroupRooms = stateManager.getCurrentGroupRooms();
                roomRenderer.renderRooms(currentGroupRooms);
            }
            
            // 异步加载真实数据
            setTimeout(() => {
                roomManager.loadRooms();
            }, 300);
            
            // 页面加载完成后触发一次后台更新
            setTimeout(() => {
                RoomOperations.updateRoomsInBackground();
            }, 1000);
            
            // 初始化定时更新服务
            await Utils.initTimerService();
        });
    </script>
</body>
</html>