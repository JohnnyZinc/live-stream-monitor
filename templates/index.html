<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聚合直播</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid px-3">
            <a class="navbar-brand fs-4" href="/">
                <i class="bi bi-broadcast"></i> 聚合直播
            </a>
            <div class="d-flex gap-2 align-items-center">
                <!-- Group selection dropdown -->
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="groupDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-collection"></i> <span id="currentGroupName">全部关注</span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="groupDropdown" id="groupMenu">
                        <!-- Groups will be populated dynamically -->
                    </ul>
                </div>
                
                <!-- 自动更新控制按钮 -->
                <div class="btn-group" role="group">
                    <button id="autoUpdateToggle" class="btn btn-success btn-sm" onclick="toggleAutoUpdate()" title="切换自动更新">
                        <i class="bi bi-play-circle"></i> 启动自动更新
                    </button>
                    <button id="manualUpdateBtn" class="btn btn-outline-primary btn-sm" onclick="manualUpdate()" title="立即更新所有直播间">
                        <i class="bi bi-arrow-clockwise"></i> 立即更新
                    </button>
                </div>
                
                <button class="btn btn-light" onclick="showApiSettingsModal()" title="API设置" style="font-size: 1rem; padding: 6px 12px;">
                    <i class="bi bi-gear"></i>
                </button>
                
                <button class="btn btn-light" onclick="modalManager.showAddModal()" title="添加直播间" style="font-size: 1rem; padding: 6px 12px;">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
            <div class="ms-2 d-flex align-items-center">
                <small id="autoUpdateStatus" class="text-muted me-2">自动更新已停止</small>
                <div id="refreshIndicator" class="spinner-border spinner-border-sm d-none" role="status" style="width: 1rem; height: 1rem;">
                    <span class="visually-hidden">加载中...</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="room-container" id="roomContainer">
            <!-- 初始状态下显示空状态 -->
            <div class="empty-state" id="emptyState" style="grid-column: 1 / -1;">
                <i class="bi bi-cloud-plus" style="font-size: 48px; color: #bdc3c7;"></i>
                <h4 class="mt-3">暂无直播间</h4>
                <p>点击右上角的"添加直播间"按钮开始添加你想要的直播间</p>
            </div>
        </div>
    </div>

    <!-- API设置模态框 -->
    <div class="modal fade" id="apiSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">抖音API设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">抖音API地址</label>
                        <input type="text" class="form-control" id="douyinApiUrl"
                               placeholder="请输入抖音API基础地址">
                        <div class="form-text">默认使用 https://douyin.wtf</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveApiSettings()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加直播间模态框 -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加直播间</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">直播间URL</label>
                        <input type="text" class="form-control" id="modalRoomUrl"
                               placeholder="支持：斗鱼、虎牙、哔哩哔哩、抖音直播间链接">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="roomManager.addRoom(document.getElementById('modalRoomUrl').value.trim())">添加</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 创建分组模态框 -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建新分组</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">分组名称</label>
                        <input type="text" class="form-control" id="newGroupName"
                               placeholder="请输入分组名称">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createNewGroup()">创建</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 分组设置模态框 -->
    <div class="modal fade" id="groupAssignmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">设置分组</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="groupAssignmentRoomUrl">
                    <div class="mb-3">
                        <label class="form-label">选择分组（可多选）</label>
                        <div id="groupCheckboxes">
                            <!-- 分组复选框将在这里动态生成 -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="showCreateGroupModalFromAssignment()">
                            <i class="bi bi-plus-circle"></i> 创建新分组
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveGroupAssignment()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 直播间选项对话框 -->
    <div class="modal fade" id="roomOptionsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header text-center py-3 border-bottom-0">
                    <div class="w-100">
                        <img id="roomOptionsAvatar" src="" alt="主播头像" class="rounded-circle mb-2" style="width: 48px; height: 48px; object-fit: cover;">
                        <h5 class="modal-title w-100" id="roomOptionsTitle">直播间选项</h5>
                    </div>
                </div>
                <div class="modal-body text-center">
                    <input type="hidden" id="roomOptionsUrl">
                    <input type="hidden" id="roomOptionsAnchorName">
                    
                    <!-- 直播封面 -->
                    <div class="mb-3">
                        <img id="roomOptionsCover" src="" alt="直播封面" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="openGroupAssignmentFromOptions()">
                            <i class="bi bi-folder-plus"></i> 设置分组
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="deleteRoomFromOptions()">
                            <i class="bi bi-x-lg"></i> 取消关注
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 基础配置 -->
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
    
    <!-- 工具模块 -->
    <script src="{{ url_for('static', filename='js/cache.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/platform.js') }}"></script>
    
    <!-- 核心模块 -->
    <script src="{{ url_for('static', filename='js/modules/stateManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/roomRenderer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/roomManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/modalManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/timerService.js') }}"></script>
    
    <!-- Bootstrap框架 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 应用初始化 -->
    <script>
        // 创建核心实例
        const roomRenderer = new RoomRenderer('roomContainer', 'emptyState');
        const roomManager = new RoomManager(stateManager, roomRenderer);
        const modalManager = new ModalManager();
        
        // 状态变化监听
        stateManager.addListener((rooms) => {
            // 更新房间显示
            const currentGroupRooms = stateManager.getCurrentGroupRooms();
            roomRenderer.renderRooms(currentGroupRooms);
            
            // 更新分组菜单
            updateGroupMenu();
        });
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化模态框管理器
            modalManager.init();
            modalManager.bindEnterKey(roomManager);
            
            // 加载分组数据
            loadGroups();
            
            // 加载抖音API配置
            loadDouyinConfig();
            
            // 优先使用缓存数据
            const cached = CacheManager.loadFromCache();
            if (cached && cached.length > 0) {
                stateManager.setRooms(cached);
                const currentGroupRooms = stateManager.getCurrentGroupRooms();
                roomRenderer.renderRooms(currentGroupRooms);
            }
            
            // 异步加载真实数据
            setTimeout(() => {
                roomManager.loadRooms();
            }, 300);
            
            // 页面加载完成后触发一次后台更新
            setTimeout(() => {
                updateRoomsInBackground();
            }, 1000);
            
            // 初始化定时更新服务
            initTimerService();
        });
        
        // 加载分组数据
        async function loadGroups() {
            try {
                const response = await APIManager.getGroups();
                if (response.success) {
                    stateManager.setGroups(response.groups);
                    updateGroupMenu();
                }
            } catch (error) {
                console.error('加载分组失败:', error);
            }
        }
        
        // 加载抖音API配置
        async function loadDouyinConfig() {
            try {
                const response = await APIManager.getDouyinConfig();
                if (response.success) {
                    const config = response.config;
                    // 如果有配置，更新本地存储
                    if (config.api_url) {
                        localStorage.setItem('douyin_api_url', config.api_url);
                    }
                }
            } catch (error) {
                console.error('加载抖音API配置失败:', error);
            }
        }
        
        // 更新分组菜单
        function updateGroupMenu() {
            const groupMenu = document.getElementById('groupMenu');
            const groups = stateManager.getGroups();
            const currentGroup = stateManager.getCurrentGroup();
            
            if (!groupMenu) return;
            
            // 清空现有菜单项
            groupMenu.innerHTML = '';
            
            // 定义系统分组的显示顺序
            const systemGroupOrder = ["全部关注", "特别关注", "直播中", "未开播"];
            
            // 先添加指定顺序的系统分组
            systemGroupOrder.forEach(groupName => {
                if (groups[groupName]) {
                    const li = document.createElement('li');
                    li.innerHTML = `<a class="dropdown-item ${currentGroup === groupName ? 'active' : ''}" 
                                      href="#" onclick="selectGroup('${groupName}')">${groupName}</a>`;
                    groupMenu.appendChild(li);
                }
            });
            
            // 再添加其他自定义分组
            Object.keys(groups).forEach(groupName => {
                // 跳过已添加的系统分组
                if (!systemGroupOrder.includes(groupName)) {
                    const li = document.createElement('li');
                    li.innerHTML = `<a class="dropdown-item ${currentGroup === groupName ? 'active' : ''}" 
                                      href="#" onclick="selectGroup('${groupName}')">${groupName}</a>`;
                    groupMenu.appendChild(li);
                }
            });
            
            // 添加分隔线
            const divider = document.createElement('li');
            divider.innerHTML = '<hr class="dropdown-divider">';
            groupMenu.appendChild(divider);
            
            // 添加创建新分组选项
            const createLi = document.createElement('li');
            createLi.innerHTML = '<a class="dropdown-item" href="#" onclick="showCreateGroupModal()"><i class="bi bi-plus-circle"></i> 创建新分组</a>';
            groupMenu.appendChild(createLi);
            
            // 更新当前分组显示
            document.getElementById('currentGroupName').textContent = currentGroup;
        }
        
        // 选择分组
        function selectGroup(groupName) {
            stateManager.setCurrentGroup(groupName);
        }
        
        // 显示创建分组模态框
        function showCreateGroupModal() {
            const modal = new bootstrap.Modal(document.getElementById('createGroupModal'));
            modal.show();
        }
        
        // 创建新分组
        async function createNewGroup() {
            const groupNameInput = document.getElementById('newGroupName');
            const groupName = groupNameInput.value.trim();
            
            if (!groupName) {
                alert('请输入分组名称');
                return;
            }
            
            try {
                const response = await APIManager.createGroup(groupName);
                if (response.success) {
                    stateManager.setGroups(response.groups);
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createGroupModal'));
                    modal.hide();
                    groupNameInput.value = '';
                    
                    // 如果是从分组设置界面创建的，需要更新分组复选框
                    if (document.getElementById('groupAssignmentModal').classList.contains('show')) {
                        const roomUrl = document.getElementById('groupAssignmentRoomUrl').value;
                        showGroupAssignmentModal(roomUrl);
                    }
                } else {
                    alert(response.error || '创建分组失败');
                }
            } catch (error) {
                alert('创建分组失败: ' + error.message);
            }
        }
        
        // 显示分组设置模态框
        function showGroupAssignmentModal(roomUrl) {
            document.getElementById('groupAssignmentRoomUrl').value = roomUrl;
            
            const groups = stateManager.getGroups();
            const groupCheckboxes = document.getElementById('groupCheckboxes');
            
            // 生成分组复选框（排除系统分组）
            let checkboxesHtml = '';
            
            // 定义系统分组的显示顺序（在设置分组中只显示特别关注）
            const systemGroupOrder = ["特别关注"];
            
            // 先添加指定顺序的系统分组
            systemGroupOrder.forEach(groupName => {
                if (groups[groupName] && (groups[groupName].type === 'system' || groupName === '特别关注')) {
                    const isChecked = groups[groupName].rooms.includes(roomUrl);
                    checkboxesHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   id="group_${groupName}" 
                                   value="${groupName}" 
                                   ${isChecked ? 'checked' : ''}>
                            <label class="form-check-label" for="group_${groupName}">
                                ${groupName}
                            </label>
                        </div>
                    `;
                }
            });
            
            // 再添加其他自定义分组
            Object.keys(groups).forEach(groupName => {
                // 只显示自定义分组（跳过系统分组和已添加的特别关注）
                if (groups[groupName].type === 'custom') {
                    const isChecked = groups[groupName].rooms.includes(roomUrl);
                    checkboxesHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   id="group_${groupName}" 
                                   value="${groupName}" 
                                   ${isChecked ? 'checked' : ''}>
                            <label class="form-check-label" for="group_${groupName}">
                                ${groupName}
                            </label>
                        </div>
                    `;
                }
            });
            
            groupCheckboxes.innerHTML = checkboxesHtml;
            
            const modal = new bootstrap.Modal(document.getElementById('groupAssignmentModal'));
            modal.show();
        }
        
        // 从分组设置界面显示创建分组模态框
        function showCreateGroupModalFromAssignment() {
            const groupModal = bootstrap.Modal.getInstance(document.getElementById('groupAssignmentModal'));
            groupModal.hide();
            
            setTimeout(() => {
                showCreateGroupModal();
            }, 300);
        }
        
        // 保存分组设置
        async function saveGroupAssignment() {
            const roomUrl = document.getElementById('groupAssignmentRoomUrl').value;
            const groups = stateManager.getGroups();
            const checkboxes = document.querySelectorAll('#groupCheckboxes input[type="checkbox"]');
            
            try {
                // 收集需要更新的分组
                const updates = [];
                
                checkboxes.forEach(checkbox => {
                    const groupName = checkbox.value;
                    const isChecked = checkbox.checked;
                    const isCurrentlyInGroup = groups[groupName].rooms.includes(roomUrl);
                    
                    // 如果状态发生变化，需要更新
                    if (isChecked !== isCurrentlyInGroup) {
                        updates.push({
                            groupName: groupName,
                            action: isChecked ? 'add' : 'remove'
                        });
                    }
                });
                
                // 依次执行更新操作
                for (const update of updates) {
                    const response = await APIManager.updateGroup(update.groupName, roomUrl, update.action);
                    if (!response.success) {
                        throw new Error(response.error || '更新分组失败');
                    }
                    // 更新本地状态
                    if (update.action === 'add') {
                        if (!groups[update.groupName].rooms.includes(roomUrl)) {
                            groups[update.groupName].rooms.push(roomUrl);
                        }
                    } else {
                        const index = groups[update.groupName].rooms.indexOf(roomUrl);
                        if (index > -1) {
                            groups[update.groupName].rooms.splice(index, 1);
                        }
                    }
                }
                
                // 更新状态管理器
                stateManager.setGroups(groups);
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('groupAssignmentModal'));
                modal.hide();
                
            } catch (error) {
                alert('保存分组设置失败: ' + error.message);
            }
        }
        
        // 显示直播间选项对话框
        function showRoomOptionsDialog(roomUrl, anchorName) {
            document.getElementById('roomOptionsUrl').value = roomUrl;
            document.getElementById('roomOptionsAnchorName').value = anchorName;
            
            // 获取房间信息并设置模态框标题、头像和封面
            const rooms = stateManager.getRooms();
            const room = rooms.find(r => r.url === roomUrl);
            
            const titleElement = document.getElementById('roomOptionsTitle');
            const avatarElement = document.getElementById('roomOptionsAvatar');
            const coverElement = document.getElementById('roomOptionsCover');
            
            if (room) {
                titleElement.textContent = anchorName;  // 移除"的直播间"后缀
                avatarElement.src = room.avatar || CONFIG.IMAGES.defaultAvatar;
                avatarElement.onerror = function() {
                    this.src = CONFIG.IMAGES.defaultAvatar;
                    this.style.filter = 'grayscale(100%)';
                };
                
                // 设置封面
                if (coverElement) {
                    coverElement.src = room.cover || CONFIG.IMAGES.defaultCover;
                    coverElement.onerror = function() {
                        this.src = CONFIG.IMAGES.defaultCover;
                        this.style.filter = 'grayscale(100%)';
                    };
                }
            } else {
                titleElement.textContent = anchorName;  // 移除"的直播间"后缀
                avatarElement.src = CONFIG.IMAGES.defaultAvatar;
                if (coverElement) {
                    coverElement.src = CONFIG.IMAGES.defaultCover;
                }
            }
            
            const modal = new bootstrap.Modal(document.getElementById('roomOptionsModal'));
            modal.show();
        }
        
        // 从选项对话框打开分组设置
        function openGroupAssignmentFromOptions() {
            const roomUrl = document.getElementById('roomOptionsUrl').value;
            
            // 关闭当前对话框
            const modal = bootstrap.Modal.getInstance(document.getElementById('roomOptionsModal'));
            modal.hide();
            
            // 延迟显示分组设置对话框
            setTimeout(() => {
                showGroupAssignmentModal(roomUrl);
            }, 300);
        }
        
        // 从选项对话框删除房间
        function deleteRoomFromOptions() {
            const roomUrl = document.getElementById('roomOptionsUrl').value;
            const anchorName = document.getElementById('roomOptionsAnchorName').value;
            
            // 关闭当前对话框
            const modal = bootstrap.Modal.getInstance(document.getElementById('roomOptionsModal'));
            modal.hide();
            
            // 确认删除
            setTimeout(() => {
                if (confirm(`确定要取消关注 "${anchorName}" 的直播间吗？`)) {
                    roomManager.deleteRoom(roomUrl);
                }
            }, 300);
        }
        
        // 确认删除房间
        function confirmDeleteRoom(roomUrl, anchorName) {
            if (confirm(`确定要取消关注 "${anchorName}" 的直播间吗？`)) {
                roomManager.deleteRoom(roomUrl);
            }
        }
        
        // 后台更新房间信息（混合模式）
        async function updateRoomsInBackground() {
            // 显示刷新指示器
            const refreshIndicator = document.getElementById('refreshIndicator');
            if (refreshIndicator) {
                refreshIndicator.classList.remove('d-none');
            }
            
            try {
                console.log("开始后台增量更新直播间信息...");
                
                // 首先获取需要更新的房间列表
                const response = await APIManager.incrementalUpdateAll();
                if (!response.success) {
                    console.error("获取房间列表失败:", response.error);
                    return;
                }
                
                const roomsToUpdate = response.rooms_to_update;
                console.log("需要更新", roomsToUpdate.length, "个直播间");
                
                // 逐个更新房间信息
                let updatedCount = 0;
                let changedCount = 0;
                
                for (const roomUrl of roomsToUpdate) {
                    try {
                        const updateResponse = await APIManager.incrementalUpdateRoom(roomUrl);
                        if (updateResponse.success) {
                            updatedCount++;
                            
                            // 更新状态管理器中的数据
                            stateManager.updateRoom(updateResponse.room_data);
                            
                            // 更新UI显示
                            roomRenderer.updateRoomCard(updateResponse.room_data);
                            
                            // 如果有变化，更新分组信息
                            if (updateResponse.has_changes) {
                                changedCount++;
                                // 更新分组信息
                                await updateRoomGroupsIfNeeded(updateResponse.room_data);
                            }
                            
                            console.log("已更新直播间:", updateResponse.room_data.anchor);
                        }
                    } catch (error) {
                        console.error("更新直播间失败:", roomUrl, error);
                    }
                    
                    // 添加小延迟避免请求过于频繁
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                console.log(`后台更新完成，共更新${updatedCount}个直播间，${changedCount}个有变化`);
                
                // 更新完成后保存缓存
                CacheManager.saveToCache(stateManager.getRooms());
                
            } catch (error) {
                console.error("后台更新出错:", error);
            } finally {
                // 隐藏刷新指示器
                if (refreshIndicator) {
                    refreshIndicator.classList.add('d-none');
                }
            }
        }
        
        // 初始化定时更新服务
        function initTimerService() {
            // 检查本地存储的开关状态
            const isSwitchOn = timerService.loadSwitchState();
            
            // 如果开关是打开的，启动定时更新服务
            if (isSwitchOn) {
                timerService.start();
            }
            
            // 监听页面关闭事件，停止定时器
            window.addEventListener('beforeunload', () => {
                timerService.stop();
            });
            
            // 添加更新监听器，用于更新UI
            timerService.addUpdateListener((data) => {
                console.log("定时更新完成:", data);
                // 可以在这里处理更新后的UI反馈
                
                // 如果当前在系统分组中，更新分组信息
                const currentGroup = stateManager.getCurrentGroup();
                if (currentGroup === "直播中" || currentGroup === "未开播") {
                    updateRoomGroupsIfNeeded();
                }
            });
        }
        
        // 切换定时更新开关
        function toggleAutoUpdate() {
            const isRunning = timerService.toggle();
            
            // 更新UI状态
            const toggleBtn = document.getElementById('autoUpdateToggle');
            if (toggleBtn) {
                toggleBtn.innerHTML = isRunning ? 
                    '<i class="bi bi-pause-circle"></i> 停止自动更新' : 
                    '<i class="bi bi-play-circle"></i> 启动自动更新';
                
                toggleBtn.className = isRunning ? 
                    'btn btn-danger btn-sm' : 
                    'btn btn-success btn-sm';
            }
            
            // 显示状态提示
            const statusText = document.getElementById('autoUpdateStatus');
            if (statusText) {
                statusText.textContent = isRunning ? '自动更新已启动' : '自动更新已停止';
                statusText.className = isRunning ? 'text-success' : 'text-muted';
            }
        }
        
        // 手动触发更新
        async function manualUpdate() {
            const updateBtn = document.getElementById('manualUpdateBtn');
            const refreshIndicator = document.getElementById('refreshIndicator');
            if (updateBtn) {
                updateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 更新中...';
                updateBtn.disabled = true;
            }
            // 显示刷新指示器
            if (refreshIndicator) {
                refreshIndicator.classList.remove('d-none');
            }
            
            try {
                await timerService.updateAllRooms();
                
                // 显示更新成功提示
                const toast = document.createElement('div');
                toast.className = 'toast success';
                toast.style.cssText = `
                    position: fixed;
                    top: 70px;
                    right: 20px;
                    z-index: 9999;
                    pointer-events: none;
                    animation: slideIn 0.3s ease-in-out;
                `;
                toast.innerHTML = `
                    <div class="alert alert-success mb-0" role="alert">
                        直播间信息更新完成
                    </div>
                `;
                
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            } catch (error) {
                console.error('手动更新失败:', error);
                
                // 显示更新失败提示
                const toast = document.createElement('div');
                toast.className = 'toast error';
                toast.style.cssText = `
                    position: fixed;
                    top: 70px;
                    right: 20px;
                    z-index: 9999;
                    pointer-events: none;
                    animation: slideIn 0.3s ease-in-out;
                `;
                toast.innerHTML = `
                    <div class="alert alert-danger mb-0" role="alert">
                        更新失败: ${error.message}
                    </div>
                `;
                
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            } finally {
                if (updateBtn) {
                    updateBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 立即更新';
                    updateBtn.disabled = false;
                }
                // 隐藏刷新指示器
                if (refreshIndicator) {
                    refreshIndicator.classList.add('d-none');
                }
            }
        }
        
        // 更新房间分组信息（如果需要）
        async function updateRoomGroupsIfNeeded(roomData) {
            try {
                // 获取当前分组
                const currentGroup = stateManager.getCurrentGroup();
                
                // 如果当前在"直播中"或"未开播"分组，需要更新分组信息
                if (currentGroup === "直播中" || currentGroup === "未开播") {
                    const response = await APIManager.updateRoomGroups(stateManager.getRooms());
                    if (response.success) {
                        stateManager.setGroups(response.groups);
                    }
                }
            } catch (error) {
                console.error("更新分组信息失败:", error);
            }
        }
        
        // 显示API设置模态框
        function showApiSettingsModal() {
            // 从本地存储加载API地址
            const savedApiUrl = localStorage.getItem('douyin_api_url') || '';
            document.getElementById('douyinApiUrl').value = savedApiUrl;
            
            const modal = new bootstrap.Modal(document.getElementById('apiSettingsModal'));
            modal.show();
        }
        
        // 保存API设置
        async function saveApiSettings() {
            const apiUrl = document.getElementById('douyinApiUrl').value.trim();
            
            try {
                // 保存到服务器
                const response = await APIManager.saveDouyinConfig(apiUrl);
                if (!response.success) {
                    throw new Error(response.error || '保存失败');
                }
                
                // 保存到本地存储
                if (apiUrl) {
                    localStorage.setItem('douyin_api_url', apiUrl);
                } else {
                    localStorage.removeItem('douyin_api_url');
                }
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('apiSettingsModal'));
                modal.hide();
                
                // 显示保存成功提示
                const toast = document.createElement('div');
                toast.className = 'toast success';
                toast.style.cssText = `
                    position: fixed;
                    top: 70px;
                    right: 20px;
                    z-index: 9999;
                    pointer-events: none;
                    animation: slideIn 0.3s ease-in-out;
                `;
                toast.innerHTML = `
                    <div class="alert alert-success mb-0" role="alert">
                        API设置已保存
                    </div>
                `;
                
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            } catch (error) {
                // 显示保存失败提示
                const toast = document.createElement('div');
                toast.className = 'toast error';
                toast.style.cssText = `
                    position: fixed;
                    top: 70px;
                    right: 20px;
                    z-index: 9999;
                    pointer-events: none;
                    animation: slideIn 0.3s ease-in-out;
                `;
                toast.innerHTML = `
                    <div class="alert alert-danger mb-0" role="alert">
                        保存失败: ${error.message}
                    </div>
                `;
                
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        }
    </script>
</body>
</html>